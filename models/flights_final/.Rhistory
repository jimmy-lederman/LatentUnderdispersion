sigma2 <- mean(sigmas^2)
lambda <- mean(lambdas, na.rm = TRUE)
betahat <- betahats[[year]]
vcovhat <- vcovhats[[year]]
vote <- df[[year]]$VOTE
unc <- unc_f(vote)
vote[which(vote < .05)] <- unc_lowr
vote[which(vote > .95)] <- unc_highr
#inc <- df[[year]]$INC
lastvote <- df[[year-1]]$VOTE
inclast <- df[[year-1]]$INC
lastvote[which(lastvote < .05)] <- unc_lowr
lastvote[which(lastvote > .95)] <- unc_highr
#lastvote[is.na(lastvote)] <- ifelse(inclast[which(is.na(lastvote))] == 1, unc_highr, unc_lowr)
X <- cbind(
intercept = 1,
lastvote = lastvote,
unc       = unc
)
rownames(X) <- df[[year]]$id
hypelect <- matrix(0,nrow = num_sim, ncol=nrow(X))
beta_NP <- MASS::mvrnorm(n=num_sim, betahat, vcovhat)
districtMean_ND <- t((lambda*vote + (1-lambda)*X %*% t(beta_NP))) + MASS::mvrnorm(n=num_sim, rep(0,nrow(X)), lambda*(1-lambda)*sigma2 * diag(nrow(X)))
districtVar <- (1-lambda)*sigma2
hypelect_ND <- districtMean_ND + rnorm(n=prod(dim(districtMean_ND)), mean = 0, sd = sqrt(districtVar))
return(t(hypelect_ND))
}
num_sim <- 100000
hypelect_judge_DN <- judge(df,"2020",num_sim)
num_sim <- 10000
hypelect_judge_DN <- judge(df,"2020",num_sim)
delta <- 0
state <- "Utah"
state_judge_DN <- hypelect_judge_DN[sub("-.*", "", rownames(hypelect_judge_DN)) == state,] + delta
votes <- colMeans(state_judge_DN)
seats <- colSums(state_judge_DN > .5)
plot(votes, seats)
table(seats)/num_sim
mean(votes)
rowMeans(state_judge_DN)
delta <- .05
state <- "Utah"
state_judge_DN <- hypelect_judge_DN[sub("-.*", "", rownames(hypelect_judge_DN)) == state,] + delta
votes <- colMeans(state_judge_DN)
seats <- colSums(state_judge_DN > .5)
plot(votes, seats)
table(seats)/num_sim
mean(votes)
rowMeans(state_judge_DN)
vars_to_sum <- c("SEN12D", "SEN12R", "PRES12D", "PRES12R", "SEN13D", "SEN13R", "SEN14D", "SEN14R",
"GOV14D", "GOV14R", "PRES16D", "PRES16R", "GOV18D", "GOV18R", "SEN18D", "SEN18R")
dfma2 <- data[[4]]
library(dplyr)
dfma <- dfma2 %>%
group_by(CD) %>%
summarise(across(all_of(vars_to_sum), ~ sum(.x, na.rm = TRUE)))
vote12SE <- dfma$SEN12D / (dfma$SEN12D + dfma$SEN12R)
vote12P <- dfma$PRES12D / (dfma$PRES12D + dfma$PRES12R)
vote13 <- dfma$SEN13D / (dfma$SEN13D + dfma$SEN13R)
vote14SE <- dfma$SEN14D / (dfma$SEN14D + dfma$SEN14R)
vote14GO <- dfma$GOV14D / (dfma$GOV14D + dfma$GOV14R)
vote16P <- dfma$PRES16D / (dfma$PRES16D + dfma$PRES16R)
vote18GO <- dfma$GOV18D / (dfma$GOV18D + dfma$GOV18R)
vote18SE <- dfma$SEN18D / (dfma$SEN18D + dfma$SEN18R)
df1 <- data.frame(VOTE=vote12SE,lastpres=vote12P)
rownames(df1) <- 1:9
df2 <- data.frame(VOTE=vote13,lastpres=vote12P)
rownames(df2) <- 1:9
df3 <- data.frame(VOTE=vote14SE,lastpres=vote12P)
df4 <- data.frame(VOTE=vote18SE,lastpres=vote16P)
df_list = list(df1, df2, df3, df4)
judge_ma <- function(df,year, num_sim=1000){
unc_f <- function(inp) -1*(inp<0.05)+1*(inp>0.95)
#reproducing how to get model parameters
unc_lowr <- .25
unc_highr <- .75
num_years <- length(df)
elecyears <- c(12,13,14,18)
same.d <- c(1,1,1,1)
sigmas <- rep(0,length(elecyears))
lambdas <- rep(0,length(elecyears))
betahats <- list()
vcovhats <- list()
for(year in 1:num_years){
data <- df[[year]]
vote <- data$VOTE
lastpres <- data$lastpres
unc <-  unc_f(vote)
vote[which(vote < .05)] <- unc_lowr
vote[which(vote > .95)] <- unc_highr
#inc <-  data$INC
if(year == 1){
model1 <- lm(vote~lastpres)
betahats[[year]] <- coefficients(model1)
vcovhats[[year]] <- vcov(model1)
sigmas[year] <- summary(model1)$sigma
datanext <- df[[year+1]]
votenext <- datanext$VOTE
uncnext <- unc_f(votenext)
lastpresnext <- datanext$lastpres
#incnext <- datanext$INC
votenext[which(votenext < .05)] <- unc_lowr
votenext[which(votenext > .95)] <- unc_highr
#model2 <- lm(votenext~vote+unc+incnext+uncnext)
model2 <- lm(votenext~vote)
lambdas[year] <- coefficients(model2)["vote"]
}else{
if(same.d[year] == 0){
#model1 <- lm(vote~unc+inc)
model1 <- lm(vote~lastpres)
betahats[[year]] <- coefficients(model1)
vcovhats[[year]] <- vcov(model1)
sigmas[year] <- summary(model1)$sigma
if(year == num_years){
lambdas[year] <- NA
}else{
datanext <- df[[year+1]]
votenext <- datanext$VOTE
uncnext <- unc_f(votenext)
lastpresnext <- datanext$lastpres
#incnext <- datanext$INC
votenext[which(votenext < .05)] <- unc_lowr
votenext[which(votenext > .95)] <- unc_highr
#model2 <- lm(votenext~vote+unc+inc+incnext+uncnext)
model2 <- lm(votenext~vote)
lambdas[year] <- coefficients(model2)["vote"]
}
}else{
datalast <- df[[year - 1]]
lastvote <- datalast$VOTE
lastvote[which(lastvote < .05)] <- unc_lowr
lastvote[which(lastvote > .95)] <- unc_highr
#model1 <- lm(vote~lastvote+unc+inc)
model1 <- lm(vote~lastvote)
betahats[[year]] <- coefficients(model1)
vcovhats[[year]] <- vcov(model1)
sigmas[year] <- summary(model1)$sigma
if(year == num_years | same.d[year + 1] == 0){
lambdas[year] <- NA
}else{
datanext <- df[[year+1]]
votenext <- datanext$VOTE
lastpresnext <- datanext$lastpres
uncnext <- unc_f(votenext)
#incnext <- datanext$INC
votenext[which(votenext < .05)] <- unc_lowr
votenext[which(votenext > .95)] <- unc_highr
#model2 <- lm(votenext~vote+unc+inc+incnext+uncnext+lastvote)
model2 <- lm(votenext~vote+lastvote)
lambdas[year] <- coefficients(model2)["vote"]
}
}
}
}
sigma2 <- mean(sigmas^2)
lambda <- mean(lambdas, na.rm = TRUE)
betahat <- betahats[[year]]
vcovhat <- vcovhats[[year]]
vote <- df[[year]]$VOTE
unc <- unc_f(vote)
vote[which(vote < .05)] <- unc_lowr
vote[which(vote > .95)] <- unc_highr
#inc <- df[[year]]$INC
lastvote <- df[[year-1]]$VOTE
inclast <- df[[year-1]]$INC
lastvote[which(lastvote < .05)] <- unc_lowr
lastvote[which(lastvote > .95)] <- unc_highr
#lastvote[is.na(lastvote)] <- ifelse(inclast[which(is.na(lastvote))] == 1, unc_highr, unc_lowr)
X <- cbind(
intercept = 1,
lastvote = lastvote
)
rownames(X) <- df[[year]]$id
hypelect <- matrix(0,nrow = num_sim, ncol=nrow(X))
beta_NP <- MASS::mvrnorm(n=num_sim, betahat, vcovhat)
districtMean_ND <- t((lambda*vote + (1-lambda)*X %*% t(beta_NP))) + MASS::mvrnorm(n=num_sim, rep(0,nrow(X)), lambda*(1-lambda)*sigma2 * diag(nrow(X)))
districtVar <- (1-lambda)*sigma2
hypelect_ND <- districtMean_ND + rnorm(n=prod(dim(districtMean_ND)), mean = 0, sd = sqrt(districtVar))
return(t(hypelect_ND))
}
num_sim <- 10000
hypelecs_DN <- judge_ma(df_list,4,num_sim=num_sim)
delta <- 0
hypelecs_DN_temp <- hypelecs_DN + delta
votes <- colMeans(hypelecs_DN_temp)
seats <- colSums(hypelecs_DN_temp > .5)
plot(votes, seats)
df <- read.csv("house_elections_1968_2022.csv")
df$other <- NULL
df$VOTE <- df$dem / (df$dem + df$gop)
df$TURNOUT <- df$dem + df$gop
df$dem <- NULL
df$gop <- NULL
df$id <- paste(df$state, df$district, sep="-")
df <- df[df$year >= 1980,]
df <- split(df, df$year)
elecyears <- seq(1980,2020,2)
names(df) <- elecyears
df[[14]] <- df[[14]][-390,]
df[[17]] <- df[[17]][-177,]
# df <- df[7:length(df)]
df2 <- read.csv("pres_cd_1952_2020.csv")
df2$ed <- ifelse(df2$ed == 99, 1, df2$ed)
df2$id <- paste(df2$state, df2$ed, sep="-")
df2$sta <- NULL
df2$rc <- NULL
df2$srce <- NULL
df2$oth1 <- NULL
df2$oth2 <- NULL
df2$TURNOUT_P <- df2$dem + df2$rep
df2$remng <- NULL
df2$wf <- NULL
df2$mov <- NULL
df2$mplur <- NULL
df2$dempct <- NULL
df2$VOTE_P <- df2$dem / (df2$dem + df2$rep)
df2$dem <- NULL
df2$rep <- NULL
df2$reppct <- NULL
df2$othpct <- NULL
df2$reppmp <- NULL
df2$tvot <- NULL
df2 <- df2[df2$year >= 1980,]
df2 <- df2[order(df2$state), ]
df2 <- split(df2, df2$year)
elecyears2 <- seq(1980,2020,4)
names(df2) <- elecyears2
for(i in 1:length(df)){
year <- elecyears[i]
if(year %% 4 == 0){
df[[i]] <- merge(df[[i]], df2[[paste(year)]][, c("id", "VOTE_P", "TURNOUT_P")], by = "id", all.x = TRUE)
}else{
df[[i]] <- merge(df[[i]], df2[[paste(year - 2)]][, c("id", "VOTE_P", "TURNOUT_P")], by = "id", all.x = TRUE)
}
}
d <- df[["2020"]]
planscore <- function(df,year,num_sim=1000){
d <- df[[year]]
names(d) <- c("id", "year", "state", "district", "v.pc", "v.t", "us.pres.pc", "us.pres.t")
d$.vt <- d$v.t <- d$v.t /100
d$us.pres.t <- d$us.pres.t / 100
##turnout## #number of simulations
#set.seed(1)
##turnout##
model <- lm(v.t ~ us.pres.t, data=d)
d$v.to.hat <- predict(model, d)
coefs <- sim(model, num_sim)
X <- model.matrix(~ us.pres.t, data=d)
tpreds <- t(coefs@coef %*% t(X))
##D proportion of vote##
model <- lm(v.pc ~ us.pres.pc,
data=d)
d$v.pc.hat <- predict(model, d)
coefs <- sim(model, num_sim)
fixed.coefs <- coef(coefs)
sigma <- sigma.hat(coefs)
X <- model.matrix(~ us.pres.pc, data=d)
rownames(X) <- d$id
vpreds <- t(coefs@coef %*% t(X))
predictions_DN <- vpreds
rownames(predictions_DN) <- d$id
return(predictions_DN)
}
num_sim <- 1000
hypelect_planscore_DN <- planscore(df,"2020",num_sim=num_sim)
planscore <- function(df,year,num_sim=1000){
d <- df[[year]]
names(d) <- c("id", "year", "state", "district", "v.pc", "v.t", "us.pres.pc", "us.pres.t")
d$.vt <- d$v.t <- d$v.t /100
d$us.pres.t <- d$us.pres.t / 100
##turnout## #number of simulations
#set.seed(1)
##turnout##
model <- lm(v.t ~ us.pres.t, data=d)
d$v.to.hat <- predict(model, d)
coefs <- sim(model, num_sim)
X <- model.matrix(~ us.pres.t, data=d)
tpreds <- t(coefs@coef %*% t(X))
##D proportion of vote##
model <- lm(v.pc ~ us.pres.pc,
data=d)
d$v.pc.hat <- predict(model, d)
coefs <- sim(model, num_sim)
fixed.coefs <- coef(coefs)
sigma <- sigma.hat(coefs)
X <- model.matrix(~ us.pres.pc, data=d)
rownames(X) <- d$id
vpreds <- t(coefs@coef %*% t(X))
predictions_DN <- vpreds
rownames(predictions_DN) <- d$id
return(predictions_DN)
}
num_sim <- 10000
hypelect_planscore_DN <- planscore(df,"2020",num_sim=num_sim)
state <- "Utah"
delta <- 0
state_planscore_DN <- hypelect_planscore_DN[sub("-.*", "", rownames(hypelect_planscore_DN)) == state,] + delta
votes <- colMeans(state_planscore_DN)
seats <- colSums(state_planscore_DN > .5)
plot(votes, seats)
hist(state_judge_DN[4,])
df["2020"]
table(seats)/num_sim
mean(votes)
rowMeans(state_judge_DN)
delta <- 0
state <- "Utah"
state_judge_DN <- hypelect_judge_DN[sub("-.*", "", rownames(hypelect_judge_DN)) == state,] + delta
votes <- colMeans(state_judge_DN)
seats <- colSums(state_judge_DN > .5)
plot(votes, seats)
table(seats)/num_sim
mean(votes)
rowMeans(state_judge_DN)
hist(state_judge_DN[4,])
j.ob <- judgeit(model=VOTE~unc_f(VOTE), vote.form=TURNOUT~1,
data=df, use.last.votes=TRUE,
same.d=same.d,simulations=num_sim,
uncontesteds.method="default",weight="constant")
unc_f <- function(inp) -1*(inp<0.05)+1*(inp>0.95)
j.ob <- judgeit(model=VOTE~unc_f(VOTE), vote.form=TURNOUT~1,
data=df, use.last.votes=TRUE,
same.d=same.d,simulations=num_sim,
uncontesteds.method="default",weight="constant")
unc_f <- function(inp) -1*(inp<0.05)+1*(inp>0.95)
elecyears <- seq(1980,2020,2)
same.d <- 1*(elecyears %% 10 != 2)
j.ob <- judgeit(model=VOTE~unc_f(VOTE), vote.form=TURNOUT~1,
data=df, use.last.votes=TRUE,
same.d=same.d,simulations=num_sim,
uncontesteds.method="default",weight="constant")
unc_f <- function(inp) -1*(inp<0.05)+1*(inp>0.95)
elecyears <- seq(1980,2020,2)
same.d <- 1*(elecyears %% 10 != 2)
j.ob <- judgeit(model=VOTE~unc_f(VOTE), vote.form=TURNOUT~1,
data=df, use.last.votes=TRUE,
same.d=same.d,simulations=num_sim,
uncontesteds.method="default",weight="constant")
year <- 2020
j.ob <- judgeit.preprocess(j.ob, year = year)
source("rawJudgeIt/visibles.R")
source("rawJudgeIt/operators.R")
source("rawJudgeIt/quantities.R")
unc_f <- function(inp) -1*(inp<0.05)+1*(inp>0.95)
elecyears <- seq(1980,2020,2)
same.d <- 1*(elecyears %% 10 != 2)
j.ob <- judgeit(model=VOTE~unc_f(VOTE), vote.form=TURNOUT~1,
data=df, use.last.votes=TRUE,
same.d=same.d,simulations=num_sim,
uncontesteds.method="default",weight="constant")
year <- 2020
j.ob <- judgeit.preprocess(j.ob, year = year)
source("rawJudgeIt/visibles.R")
source("rawJudgeIt/operators.R")
source("rawJudgeIt/quantities.R")
unc_f <- function(inp) -1*(inp<0.05)+1*(inp>0.95)
elecyears <- seq(1980,2020,2)
same.d <- 1*(elecyears %% 10 != 2)
j.ob <- judgeit(model=VOTE~unc_f(VOTE), vote.form=TURNOUT~1,
data=df, use.last.votes=TRUE,
same.d=same.d,simulations=num_sim,
uncontesteds.method="default",weight="constant")
year <- 2020
j.ob <- judgeit.preprocess(j.ob, year = year)
hype_elecs.judge <- hyp.elects(j.ob2,zero.mean=FALSE)
source("rawJudgeIt/visibles.R")
source("rawJudgeIt/operators.R")
source("rawJudgeIt/quantities.R")
unc_f <- function(inp) -1*(inp<0.05)+1*(inp>0.95)
elecyears <- seq(1980,2020,2)
same.d <- 1*(elecyears %% 10 != 2)
j.ob <- judgeit(model=VOTE~unc_f(VOTE), vote.form=TURNOUT~1,
data=df, use.last.votes=TRUE,
same.d=same.d,simulations=num_sim,
uncontesteds.method="default",weight="constant")
year <- 2020
j.ob <- judgeit.preprocess(j.ob, year = year)
hype_elecs.judge <- hyp.elects(j.ob,zero.mean=FALSE)
hype_elecs.judge
dim(hype_elecs.judge)
dim(hype_elecs.judge$votes)
rownames(hype_elecs.judge$votes)
rownames(hype_elecs.judge$votes) <- rownames(hypelect_judge_DN)
hype_elecs.judge[sub("-.*", "", rownames(hype_elecs.judge)) == state,]
sub("-.*", "", rownames(hype_elecs.judge)) == state
sub("-.*", "", rownames(hype_elecs.judge)) == "Utah"
hype_elecs.judge
hype_elecs.judge[1:10,]
rownames(hype_elecs.judge) <- rownames(hypelect_judge_DN)
source("rawJudgeIt/visibles.R")
source("rawJudgeIt/operators.R")
source("rawJudgeIt/quantities.R")
unc_f <- function(inp) -1*(inp<0.05)+1*(inp>0.95)
elecyears <- seq(1980,2020,2)
same.d <- 1*(elecyears %% 10 != 2)
j.ob <- judgeit(model=VOTE~unc_f(VOTE), vote.form=TURNOUT~1,
data=df, use.last.votes=TRUE,
same.d=same.d,simulations=num_sim,
uncontesteds.method="default",weight="constant")
year <- 2020
j.ob <- judgeit.preprocess(j.ob, year = year)
hype_elecs.judge <- hyp.elects(j.ob,zero.mean=FALSE)
rownames(hype_elecs.judge) <- rownames(hypelect_judge_DN)
dim(hype_elecs.judge)
dim(hype_elecs.judge$votes)
rownames(hype_elecs.judge$votes)
rownames(hype_elecs.judge$votes) <- rownames(hypelect_judge_DN)
rownames(hype_elecs.judge$votes)
hype_elecs.judge$votes[sub("-.*", "", rownames(hype_elecs.judge)) == "Utah",]
dim(hype_elecs.judge$votes[sub("-.*", "", rownames(hype_elecs.judge)) == "Utah",])
hype_elecs.judge$votes[sub("-.*", "", rownames(hype_elecs.judge)) == "Utah",]
hype_elecs.judge$votes[sub("-.*", "", rownames(hype_elecs.judge$votes)) == "Utah"]
source("rawJudgeIt/visibles.R")
source("rawJudgeIt/operators.R")
source("rawJudgeIt/quantities.R")
unc_f <- function(inp) -1*(inp<0.05)+1*(inp>0.95)
elecyears <- seq(1980,2020,2)
same.d <- 1*(elecyears %% 10 != 2)
j.ob <- judgeit(model=VOTE~unc_f(VOTE), vote.form=TURNOUT~1,
data=df, use.last.votes=TRUE,
same.d=same.d,simulations=num_sim,
uncontesteds.method="default",weight="constant")
year <- 2020
j.ob <- judgeit.preprocess(j.ob, year = year)
hype_elecs.judge <- hyp.elects(j.ob,zero.mean=FALSE)
judge_DN <- hype_elecs.judge$votes
judge_DN[sub("-.*", "", rownames(judge_DN)) == "Utah"]
judge_DN
dim(judge_DN)
judge_DN[1:10,1:10]
source("rawJudgeIt/visibles.R")
source("rawJudgeIt/operators.R")
source("rawJudgeIt/quantities.R")
unc_f <- function(inp) -1*(inp<0.05)+1*(inp>0.95)
elecyears <- seq(1980,2020,2)
same.d <- 1*(elecyears %% 10 != 2)
j.ob <- judgeit(model=VOTE~unc_f(VOTE), vote.form=TURNOUT~1,
data=df, use.last.votes=TRUE,
same.d=same.d,simulations=num_sim,
uncontesteds.method="default",weight="constant")
year <- 2020
j.ob <- judgeit.preprocess(j.ob, year = year)
hype_elecs.judge <- hyp.elects(j.ob,zero.mean=FALSE)
judge_DN <- hype_elecs.judge$votes
rownames(judge_DN) <- rownames(hypelect_judge_DN)
judge_DN[1:10,1:10]
judge_DN[sub("-.*", "", rownames(judge_DN)) == "Utah"]
dim(judge_DN[sub("-.*", "", rownames(judge_DN)) == "Utah"])
judge_DN[sub("-.*", "", rownames(judge_DN)) == "Utah",]
dim(judge_DN[sub("-.*", "", rownames(judge_DN)) == "Utah",])
utah_judge_DN <- judge_DN[sub("-.*", "", rownames(judge_DN)) == "Utah",]
utah_judge_DN <- judge_DN[sub("-.*", "", rownames(judge_DN)) == "Utah",]
votesjudge <- colMeans(state_judge_DN)
seatsjudge <- colSums(state_judge_DN > .5)
plot(votesjudge,seatsjudge)
table(seatsjudge)/num_sim
mean(votesjudge)
rowMeans(state_judge_DN)
library(brms)
library(COMPoissonReg)
datafile = "/Users/jimmy/Desktop/OrderStats/data/flights_data/flights_final.csv"
df <- read.csv(datafile)
y <- df$AIR_TIME
home_N <- df$origin
away_N <- df$dest
routes_R4 <- list()
airports <- 99
for (t1 in 1:airports) {
for (t2 in 1:airports) {
bitvector <- (home_N == t1) & (away_N == t2)
if (sum(bitvector) != 0) {
indices <- which(bitvector)
routes_R4[[length(routes_R4) + 1]] <-
list(t1, t2)
}
}
}
routes_R4 <- do.call(rbind, lapply(routes_R4, function(x) {
data.frame(
t1 = x[[1]],
t2 = x[[2]]
)
}))
routes_R4$route <- 1:nrow(routes_R4)
routes <- with(
df,
routes_R4$route[
match(
paste(origin, dest),
paste(routes_R4$t1, routes_R4$t2)
)
]
)
df$route <- as.factor(routes)
df_small <- df[1:1000,]
brm(
AIR_TIME ~ route,
data = df,
family = brmsfamily("com_poisson"),
chains = 1,
iter = 10,
warmup = 5
)
df_small <- df[1:1000,]
model <- brm(
AIR_TIME ~ route,
data = df,
family = brmsfamily("com_poisson"),
chains = 1,
iter = 10,
warmup = 5
)
